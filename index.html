<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript"
			src="http://maps.google.com/maps/api/js?key=AIzaSyC8080U0sQQ0ilWJe_e6r-GfkM8fhjewSs"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
		.container, .container > div, .container > div #map-canvas {
			height: inherit;
		}
		.driver-information {
			display: flex;
			background: #ffffff;
			position: fixed;
			bottom: 0;
			width: 100%;
			padding: 15px;
		}
		p.driver-car-details {
			margin: 0;
			line-height: 18px;
			font-size: 15px;
			font-family: sans-serif;
			font-weight: 300;
		}
		.fixed{
			width: 20%;
			padding: 5px;
		}
		.flex-item{
			padding: 5px;
			flex-grow: 1;
		}
		.profile-icon {
			border: 2px solid #8e8a8a;
			width: 60px;
			height: 60px;
			border-radius: 60px;
		}
		button.call-button {
			border: 1px solid #8e8a8a;
			background: #fff;
			margin-top: 5px;
			border-radius: 2px;
			width: 20%;
			padding: 5px;
			color: #E60000;
			font-weight: 600;
		}
		.bold {
			font-weight: bold;
		}
		div#eta-info {
			position: absolute;
			top: 71%;
			background: #000000;
			width: 44px;
			height: 44px;
			border: 3px solid #fff;
			border-radius: 50px;
			color: #fff;
			text-align: center;
		}
		span.time {
			padding: 2px !important;
			font-size: 13px;
			text-transform: uppercase;
			font-family: sans-serif;
		}
	</style>
<script>


	// on load of page
	$(function(){
        getInstallerLocation();

        setInterval(function(){
            getInstallerLocation();
            console.log('updated ... ');
            //send the updated location of the installer and redraw the pin
        }, 15000); //15 second refresh

        var socket = io.connect('http://localhost:8080');

        var map = new google.maps.Map(document.getElementById('map-canvas'), {
            zoom: 15,
			scale: 2,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay = new google.maps.DirectionsRenderer();
        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById('panel'));

        // on connection to server, ask for user's name with an anonymous callback
        socket.on('connect', function(){
            // call the server-side function 'adduser' and send one parameter (value of prompt)
            var username = getQueryVariable("username");
            var salesOrderNumber = getQueryVariable("salesordernumber");
            var userType = getQueryVariable("type");
            if(username !="" && salesOrderNumber != ""){
                socket.emit('adduser', {username, salesOrderNumber});
                if(userType == "installer")
                {
                    getInstallerLocation();
                    $('#tracking-details').html('');
                    var html = "<div class=\"driver-information\">\n" +
                        "\t\t\t<div class=\"fixed\">\n" +
                        "\t\t\t\t<img src=\"http://d2m1kqghccc19k.cloudfront.net/wp-content/uploads/2017/11/28171621/bfdc2e8f2262d629bf7ca768978fe404.jpg\" class=\"profile-icon\">\n" +
                        "\t\t\t</div>\n" +
                        "\t\t\t<div class=\"flex-item\">\n" +
                        "\t\t\t\t<p class=\"driver-car-details\">Samantha Roux</p>\n" +
                        "\t\t\t\t<p class=\"driver-car-details\">086 Vodacom Boulevard</p>\n" +
                        "\t\t\t\t<button class=\"call-button\" >Call</button>\n" +
                        "\t\t\t</div>\n" +
                        "\t\t</div>";

                    $('#tracking-details').html(html);
                }
                else
                {
                    $('#tracking-details').html('');
                    var html = "<div class=\"driver-information\">\n" +
                        "\t\t\t<div class=\"fixed\">\n" +
                        "\t\t\t\t<img src=\"https://biology.stanford.edu/sites/default/files/9e55531dd374c731136e4cd0d68045cd.jpg\" class=\"profile-icon\">\n" +
                        "\t\t\t</div>\n" +
                        "\t\t\t<div class=\"flex-item\">\n" +
                        "\t\t\t\t<p class=\"driver-car-details bold\">Jin Sam</p>\n" +
                        "\t\t\t\t<p class=\"driver-car-details\">Open Serve Installer</p>\n" +
                        "\t\t\t\t<button class=\"call-button\" >Call</button>\n" +
                        "\t\t\t</div>\n" +
                        "\t\t</div>";

                    $('#tracking-details').html(html);
                }
            }
            else
            {
                alert("You are a lost soul")
            }


        });


        function getInstallerLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                $('#demo').text("Geolocation is not supported by this browser.");
            }
        }


        function showPosition(position) {
            $('#demo').append('<div>' + "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude+ '</div>');

            var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
            var end = new google.maps.Marker({
                position: new google.maps.LatLng(-25.9717542, 28.1232506),
                map: map,
                icon: image
            });

            var request = {
                origin: new google.maps.LatLng(position.coords.latitude,position.coords.longitude),
                //destination: new google.maps.LatLng(-25.9683253,28.1259053),
                destination: end,
                //destination: 'Midrand Lutheran Church',
                travelMode: google.maps.DirectionsTravelMode.WALKING
            };



            directionsService.route(request, function(response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    var point = response.routes[0].legs[0];
                    $('.time').html(point.duration.text)
                   // console.log('Estimated travel time: ' + point.duration.text + ' (' + point.distance.text + ')');
                    directionsDisplay.setDirections(response);
                }
            });

        }

        // listener, whenever the server emits 'updatechat', this updates the chat body
        socket.on('updatechat', function (username, data) {
            $('#conversation').append('<b>'+username + ':</b> ' + data + '<br>');
        });

        // listener, whenever the server emits 'updaterooms', this updates the room the client is in
        socket.on('updaterooms', function(rooms, current_room) {
            $('#rooms').empty();
            $.each(rooms, function(key, value) {
                if(value == current_room){
                    $('#rooms').append('<div>' + value + '</div>');
                }
                else {
                    $('#rooms').append('<div><a href="#" onclick="switchRoom(\''+value+'\')">' + value + '</a></div>');
                }
            });
        });



        function getQueryVariable(variable)
        {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] == variable){return pair[1];}
            }
            return(false);
        }

        //
        //
        // function switchRoom(room){
        //     socket.emit('switchRoom', room);
        // }

		// when the client clicks SEND
		$('#datasend').click( function() {
			var message = $('#data').val();
			$('#data').val('');
			// tell server to execute 'sendchat' and send along one parameter
			socket.emit('sendchat', message);
		});

		// when the client hits ENTER on their keyboard
		$('#data').keypress(function(e) {
			if(e.which == 13) {
				$(this).blur();
				$('#datasend').focus().click();
			}
		});
	});

</script>

<body>

<div class="container">
	<div id="tracking">
		<div id="map-canvas"></div>
		<div id="eta-info">
			<span class="time">--:--</span>
		</div>
		<div id="tracking-details"></div>
	</div>
</div>
<!--<div style="width: 100%;">-->
	<!--<div id="map" style="width: 600px; height: 400px; float: left;"></div>-->
	<!--&lt;!&ndash;<div id="panel" style="width: 300px; float: right;"></div>&ndash;&gt;-->
<!--</div>-->

<!--<div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">-->
	<!--<b>ROOMS</b>-->
	<!--<div id="rooms"></div>-->
<!--</div>-->
<!--<div style="float:left;width:300px;height:250px;overflow:scroll-y;padding:10px;">-->
	<!--<div id="conversation"></div>-->
	<!--<input id="data" style="width:200px;" />-->
	<!--<input type="button" id="datasend" value="send" />-->


	<!--<p id="demo">Show the results here</p>-->
<!--</div>-->

</body>
</html>